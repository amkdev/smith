void 0===Craft.Smith&&(Craft.Smith={}),function(t){Craft.Smith.Init=Garnish.Base.extend({smithMenus:[],init:function(a){Garnish.requestAnimationFrame(t.proxy((function(){for(var a=Garnish.$doc.find(".matrix-field"),e=0;e<a.length;e++)for(var i=t(a[e]),s=i.find("> .blocks > .matrixblock"),r=0;r<s.length;r++){var n=t(s[r]),l=n.find(".actions .settings.menubtn");this.smithMenus.push(new Craft.Smith.Menu(i,n,s))}Garnish.on(Craft.MatrixInput,"blockAdded",t.proxy(this,"blockAdded")),Craft.SuperTable&&Craft.SuperTable.MatrixInputAlt&&Garnish.on(Craft.SuperTable.MatrixInputAlt,"blockAdded",t.proxy(this,"blockAdded"))}),this))},blockAdded:function(a){Garnish.requestAnimationFrame(t.proxy((function(){var e=a.target.$container,i=e.find("> .blocks > .matrixblock"),s=t(a.$block),r;s.data("block")?(t.each(this.smithMenus,(function(t,a){a.$matrixBlocks=i})),this.smithMenus.push(new Craft.Smith.Menu(e,s,i))):this.blockAdded(a)}),this))}}),Craft.Smith.Menu=Garnish.Base.extend({init:function(a,e,i){this.$matrixField=a,this.$matrixBlock=e,this.$matrixBlocks=i,this.blockInstance=this.$matrixBlock.data("block");var s=this.blockInstance.$actionMenu.find('a[data-action="delete"]').parents("li");this.$copyBtn=t('<a data-icon="copy" data-action="copy">'+Craft.t("app","Copy")+"</a>"),this.$pasteBtn=t('<a data-icon="paste" data-action="paste">'+Craft.t("app","Paste")+"</a>"),this.$cloneBtn=t('<a data-icon="clone" data-action="clone">'+Craft.t("app","Clone")+"</a>"),this.$copyBtn.insertBefore(s).wrap("<li/>"),this.$pasteBtn.insertBefore(s).wrap("<li/>"),this.$cloneBtn.insertBefore(s).wrap("<li/>"),t('<hr class="padded">').insertBefore(s),this.addListener(this.$copyBtn,"click",this.handleClick),this.addListener(this.$pasteBtn,"click",this.handleClick),this.addListener(this.$cloneBtn,"click",this.handleClick),this.checkPaste()},handleClick:function(a){var e=t(a.target);e.hasClass("disabled")||e.hasClass("sel")||("copy"==e.data("action")&&this.copyBlock(a),"paste"==e.data("action")&&this.pasteBlock(a),"clone"==e.data("action")&&this.cloneBlock(a),this.blockInstance.actionDisclosure.hide())},checkPaste:function(){var t=!1;try{var a=JSON.parse(localStorage.getItem("smith:block")),e=this.$matrixField.attr("id");a&&e.includes("fields-"+a.field)&&(t=!0)}catch(t){}t?this.$pasteBtn.enable():this.$pasteBtn.disable()},copyBlock:function(t){var a=this._serializeBlocks();localStorage.setItem("smith:block",JSON.stringify(a));var e=a.blocks.length,i=1==e?"1 block copied":"{n} blocks copied";Craft.cp.displayNotice(Craft.t("app",i,{n:e})),this.checkPaste()},pasteBlock:function(a,e){try{if(!e)var e=JSON.parse(localStorage.getItem("smith:block"));var i=this.$matrixField.find(".blocks"),s=t('<div class="spinner smith-spinner"></div>').insertAfter(this.$matrixBlock),r=this.$matrixField.data("matrix"),n=s;e.placeholderKey=r.settings.placeholderKey,Craft.postActionRequest("smith/field/render-matrix-blocks",e,t.proxy((function(t,a){if("success"===a&&t.success)for(var e=0;e<t.blocks.length;e++){var i=t.blocks[e],l=r.blockTypesByHandle[i.typeHandle];r.blockTypesByHandle[i.typeHandle]=i;var c=r.addBlock(i.typeHandle,n);r.blockTypesByHandle[i.typeHandle]=l}s.remove()}),this))}catch(a){}},cloneBlock:function(t){var a=this._serializeBlocks();this.pasteBlock(t,a)},_serializeBlocks:function(){var a={field:"",namespace:"",blocks:[]},e=this.$matrixField.data("matrix"),i=e.blockSelect.$selectedItems;a.placeholderKey=e.settings.placeholderKey,i.length||(i=this.$matrixBlock);for(var s=0;s<i.length;s++){var r=t(i[s]),n=Garnish.getPostData(r),l,c;if(r.parents(".field").length>1){var o={};for(var d in n){var h=d.replace(/^fields.+?(fields])/gm,"fields");a.namespace=d.match(/^fields.+?(fields])/gm)[0],o[h]=n[d]}var f=Craft.expandPostArray(o)}else var f=Craft.expandPostArray(n);var p=f.fields;for(var k in p)for(var b in a.field=k,p[k].blocks){var u=p[k].blocks[b];u.blockId=r.data("id"),a.blocks.push(u)}}return a=this.filterBlocks(a)},filterBlocks:function(t){var a=this;if(t.blocks&&Array.isArray(t.blocks)&&(t.blocks=t.blocks.filter((function(t){return null!=t})),t.sortOrder)){for(var e=[],i=0;i<t.blocks.length;i++)e.push(i);t.sortOrder=e}return Object.keys(t).forEach((function(e){var i=t[e];if(Array.isArray())for(var s=0;s<i.length;s++)a.filterBlocks(i[s]);"object"==typeof i&&a.filterBlocks(i)})),t}})}(jQuery);
//# sourceMappingURL=smith.js.map